# ==================================================================================
# HD189733b Transmission Spectrum - Barstow 2020 Setup
# ==================================================================================

# ----------------------------------------------------------------------------------
# Data Section
# ----------------------------------------------------------------------------------
data:
  obs: ../../obs_data/HD189733b_transmission_Sing2016.txt
  stellar: None
  nasa9: ../../NASA9/

# ----------------------------------------------------------------------------------
# Physics Section
# ----------------------------------------------------------------------------------
physics:
  nlay: 99

  # Vertical structure schemes
  vert_Tp: Barstow
  vert_alt: variable_g
  vert_chem: constant_vmr
  vert_mu: dynamic
  vert_cloud: None

  # Opacity sources
  opac_line: lbl
  opac_ray: None
  opac_cia: None
  opac_cloud: deck_and_powerlaw
  opac_special: None

  # Radiative transfer
  rt_scheme: transit_1d
  em_scheme: eaa
  emission_mode: planet
  contri_func: false

# ----------------------------------------------------------------------------------
# Opacity Section
# ----------------------------------------------------------------------------------
opac:
  wl_master: wl_R10000.txt
  full_grid: false
  ck: false
  ck_mix: RORR

  # Line opacity files
  line:
    - {species: H2O, path: ../../opac_data/lbl/H2O_R10000.npz}

  # Rayleigh scattering species
  ray: None

  # CIA opacity files
  cia: None

  # Cloud opacity
  cloud: None

# ----------------------------------------------------------------------------------
# Parameters Section
# ----------------------------------------------------------------------------------
params:
  # Stellar parameters
  - {name: R_s, dist: delta, value: 0.776484, transform: identity, init: 0.776484}

  # Atmospheric boundaries
  - {name: p_bot, dist: delta, value: 1000.0, transform: identity, init: 1000.0}
  - {name: p_top, dist: delta, value: 1e-8, transform: identity, init: 1e-8}

  # Planetary parameters
  - {name: log_10_g, dist: uniform, low: 2.9, high: 3.4, transform: logit, init: 3.0}
  - {name: R_p, dist: uniform, low: 0.9, high: 1.3, transform: logit, init: 1.0}

  # T-p profile parameters
  - {name: T_strat, dist: uniform, low: 100.0, high: 3000.0, transform: logit, init: 1500.0}

  # Chemistry parameters
  - {name: log_10_f_H2O, dist: uniform, low: -12, high: -2, transform: logit, init: -4}

  # Cloud parameters
  - {name: log_10_k_cld_grey, dist: uniform, low: -6.0, high: 6.0, transform: logit, init: -5.0}
  - {name: log_10_k_cld_Ray, dist: uniform, low: -6.0, high: 6.0, transform: logit, init: -3.0}
  - {name: alpha_cld, dist: uniform, low: 0.0, high: 6.0, transform: logit, init: 4.0}
  - {name: wl_ref_cld, dist: delta, value: 0.3, transform: identity, init: 0.3}

# ----------------------------------------------------------------------------------
# Sampling Section
# ----------------------------------------------------------------------------------
sampling:
  engine: dynesty

  # NUTS / HMC settings
  nuts:
    backend: numpyro
    warmup: 100
    draws: 200
    seed: 42
    chains: 1

  # JAXNS settings
  jaxns:
    max_samples: 100000
    num_live_points: 250
    s: 4
    k: 0
    c: null
    shell_fraction: 0.5
    difficult_model: false
    parameter_estimation: true
    gradient_guided: false
    init_efficiency_threshold: 0.1
    verbose: true

    termination:
      ess: 10000
      evidence_uncert: null
      dlogZ: 1.0
      max_samples: 100000
      max_num_likelihood_evaluations: null
      rtol: null
      atol: null

    posterior_samples: 2500
    seed: 42

  # BlackJAX nested sampling settings
  blackjax_ns:
    num_live_points: 250
    num_inner_steps: 24
    num_delete: 10
    dlogz_stop: 1.0
    seed: 42

  # Dynesty settings
  dynesty:
    nlive: 250
    bound: multi
    sample: auto
    dlogz: 1.0
    maxiter: null
    maxcall: null
    bootstrap: 0
    enlarge: null
    update_interval: null
    dynamic: false
    print_progress: true
    seed: 42

  # UltraNest settings
  ultranest:
    num_live_points: 250
    min_num_live_points: 250
    dlogz: 1.0
    max_iters: 0
    verbose: true
    show_status: true

  # PyMultiNest settings
  pymultinest:
    n_live_points: 250              # Number of live points
    evidence_tolerance: 1.0          # dlogZ stopping criterion
    sampling_efficiency: 0.3         # 0.8 (unimodal), 0.3 (multimodal)
    n_iter_before_update: 100        # Update interval for proposals
    null_log_evidence: -1.0e99       # Null evidence (usually leave default)
    max_modes: 100                   # Maximum number of modes to find
    mode_tolerance: -1.0e99          # Mode separation tolerance
    seed: -1                         # Random seed (-1 = random, >=0 for reproducibility)
    verbose: true                    # Print progress
    resume: true                     # Resume from previous run if interrupted
    importance_nested_sampling: false # Use importance nested sampling
    multimodal: true                 # Enable multimodal mode detection
    const_efficiency_mode: false     # Constant efficiency mode

# ----------------------------------------------------------------------------------
# Runtime Section
# ----------------------------------------------------------------------------------
runtime:
  platform: cpu
  cuda_visible_devices: 0
  threads: 1
