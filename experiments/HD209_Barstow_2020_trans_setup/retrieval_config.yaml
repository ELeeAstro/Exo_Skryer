# ==================================================================================
# HD209458b Transmission Spectrum - Barstow 2020 Setup
# ==================================================================================

# ----------------------------------------------------------------------------------
# Data Section
# ----------------------------------------------------------------------------------
data:
  obs: ../../obs_data/HD209458b_transmission_Sing2016.txt
  stellar: None
  nasa9: ../../NASA9/

# ----------------------------------------------------------------------------------
# Physics Section
# ----------------------------------------------------------------------------------
physics:
  nlay: 99       # number of atmospheric layers

  # Vertical structure schemes
  # T-P profile. Options: isothermal | guillot | modified_guillot | milne | modified_milne |
  #                        barstow | line | picket_fence | mands
  vert_Tp: Barstow

  # Altitude kernel. Options: hypsometric (constant g) | variable_g | p_ref (variable g + p_ref param)
  vert_alt: variable_g

  # Chemistry. Options: constant_vmr | constant_vmr_clr (CLR-parameterised) |
  #                     ce (FastChem equil.) | rate_ce (rate-based equil.) | quench_approx
  vert_chem: constant_vmr

  # Mean molecular weight. Options: dynamic (computed from VMR) | constant (uses 'mu' param) | auto
  vert_mu: dynamic

  # Cloud vertical profile. Options: none | exponential | slab | constant
  vert_cloud: const_profile

  # Opacity sources
  # Line opacity mode. Options: lbl (line-by-line) | ck (correlated-k) | None (off)
  # Note: 'ck' here must match opac.ck: True below.
  opac_line: ck
  opac_ray: ck      # lbl | ck | None
  opac_cia: ck      # lbl | ck | None
  # Cloud opacity. Options: none | grey | powerlaw | f18 | madt_rayleigh | lxmie | direct_nk
  opac_cloud: F18
  opac_special: None  # on (H- bound-free/free-free) | None
  cloud_dist: mono    # mono (monodisperse) | log_normal (lognormal size distribution)

  # Radiative transfer
  rt_scheme: transit_1d   # transit_1d | emission_1d
  contri_func: false       # True to return contribution functions alongside spectra
  refraction: None         # none | cutoff (refractive cutoff; requires 'a_sm' param and ray data)

  # --- Emission-only settings (ignored when rt_scheme: transit_1d) ---
  # em_scheme: eaa          # Emission solver. Options: eaa | twostream | ...
  # emission_mode: planet   # planet | brown_dwarf

# ----------------------------------------------------------------------------------
# Opacity Section
# ----------------------------------------------------------------------------------
opac:
  wl_master: ../../opac_data/ck/wl_ck_R250.txt
  full_grid: false   # True = use entire master grid; False = cut to observation coverage
  ck: True           # Must be True when physics.opac_line: ck
  # CK mixing scheme. Options: RORR (random overlap) | TRANS (per-species)
  ck_mix: TRANS

  # Line opacity files
  line:
    - {species: H2O, path: ../../opac_data/ck/H2O_ck_R250.npz}
    - {species: Na,  path: ../../opac_data/ck/Na_ck_R250.npz}
    - {species: K,   path: ../../opac_data/ck/K_ck_R250.npz}

  # Rayleigh scattering species
  ray:
    - {species: H2}
    - {species: He}

  # CIA opacity files
  cia:
    - {species: H2-H2, path: ../../opac_data/cia/H2-H2_2011.npz}
    - {species: H2-He, path: ../../opac_data/cia/H2-He_2011.npz}

  # Cloud opacity
  cloud: None

# ----------------------------------------------------------------------------------
# Parameters Section
# ----------------------------------------------------------------------------------
params:
  # --- Fixed (delta) system parameters ---
  - {name: R_s,   dist: delta, value: 1.18655, transform: identity, init: 1.18655}  # stellar radius [R_sun]
  - {name: p_bot, dist: delta, value: 100.0,   transform: identity, init: 100.0  }  # bottom pressure [bar]
  - {name: p_top, dist: delta, value: 1e-8,    transform: identity, init: 1e-8   }  # top pressure [bar]

  # --- Free planetary parameters ---
  - {name: log_10_g, dist: uniform, low: 2.7, high: 3.3,    transform: logit, init: 3.0   }  # surface gravity [log10 cm/s^2]
  - {name: R_p,      dist: uniform, low: 1.1, high: 1.5,    transform: logit, init: 1.4   }  # planet radius [R_jup]

  # --- T-P profile parameters (Barstow) ---
  - {name: T_strat, dist: uniform, low: 100.0, high: 3000.0, transform: logit, init: 1500.0}  # stratospheric temperature [K]

  # --- Chemistry (log10 VMR) ---
  - {name: log_10_f_H2O, dist: uniform, low: -12, high: -2, transform: logit, init: -5}
  - {name: log_10_f_Na,  dist: uniform, low: -12, high: -2, transform: logit, init: -6}
  - {name: log_10_f_K,   dist: uniform, low: -12, high: -2, transform: logit, init: -6}

  # --- Cloud (constant profile + F18 opacity) ---
  - {name: log_10_q_c,  dist: uniform, low: -12, high: 0,  transform: logit, init: 0   }  # cloud mass mixing ratio [log10]
  - {name: log_10_cld_r, dist: uniform, low:  -3, high: 2, transform: logit, init: 0   }  # particle radius [log10 micron]
  - {name: cld_rho, dist: delta,   value: 1.0,             transform: identity, init: 1.0}  # particle density [g/cm^3]
  - {name: cld_Q0,  dist: uniform, low: 0.1,  high: 65,   transform: logit, init: 30.0 }
  - {name: cld_Q1,  dist: delta,   value: 1.0,             transform: identity, init: 1.0}
  - {name: cld_a,   dist: uniform, low: 3.0,  high: 7.0,  transform: logit, init: 4.0  }
  - {name: f_cloud, dist: uniform, low: 0.01, high: 0.99, transform: logit, init: 0.5  }  # cloud fraction

# ----------------------------------------------------------------------------------
# Sampling Section
# ----------------------------------------------------------------------------------
sampling:
  # Active engine: dynesty | jaxns | nuts | blackjax_ns | ultranest | polychord | pymultinest
  # Only the section matching 'engine' below is used at runtime.
  engine: dynesty

  # NUTS / HMC settings
  nuts:
    backend: numpyro
    warmup: 1000
    draws: 1000
    seed: 42
    chains: 1

  # JAXNS settings
  jaxns:
    max_samples: 100000
    num_live_points: 1000
    s: 4
    k: 0
    c: null
    shell_fraction: 0.5
    difficult_model: false
    parameter_estimation: true
    gradient_guided: false
    init_efficiency_threshold: 0.1
    verbose: true

    termination:
      ess: 10000
      evidence_uncert: null
      dlogZ: 0.1
      max_samples: 100000
      max_num_likelihood_evaluations: null
      rtol: null
      atol: null

    posterior_samples: 10000
    seed: 42

  # BlackJAX nested sampling settings
  blackjax_ns:
    num_live_points: 1000
    num_inner_steps: 30
    num_delete: 500
    dlogz_stop: 0.1
    seed: 42

  # Dynesty settings
  dynesty:
    nlive: 100
    bound: multi
    sample: auto
    dlogz: 1.0
    maxiter: null
    maxcall: null
    bootstrap: 0
    enlarge: null
    update_interval: null
    dynamic: false
    print_progress: true
    seed: 42

  # UltraNest settings
  ultranest:
    num_live_points: 1000
    min_num_live_points: 1000
    dlogz: 0.1
    max_iters: 0
    verbose: true
    show_status: true

  # PyMultiNest settings
  pymultinest:
    n_live_points: 1000              # Number of live points
    evidence_tolerance: 0.1          # dlogZ stopping criterion
    sampling_efficiency: 0.3         # 0.8 (unimodal), 0.3 (multimodal)
    n_iter_before_update: 100        # Update interval for proposals
    null_log_evidence: -1.0e99       # Null evidence (usually leave default)
    max_modes: 100                   # Maximum number of modes to find
    mode_tolerance: -1.0e99          # Mode separation tolerance
    seed: -1                         # Random seed (-1 = random, >=0 for reproducibility)
    verbose: true                    # Print progress
    resume: true                     # Resume from previous run if interrupted
    importance_nested_sampling: false # Use importance nested sampling
    multimodal: true                 # Enable multimodal mode detection
    const_efficiency_mode: false     # Constant efficiency mode

  # PolyChord settings
  polychord:
    nlive: 100                      # Number of live points
    num_repeats: 5                   # Slice sampling repeats per live point (nDims * num_repeats gives chain length)
    nprior: -1                       # Number of prior samples (-1 = nlive * 10)
    do_clustering: true              # Enable multimodal clustering
    feedback: 1                      # Verbosity level (0=silent, 1=normal, 2=detailed, 3=debug)
    precision_criterion: 1.0         # Evidence stopping criterion (dlogZ)
    max_ndead: -1                    # Maximum number of dead points (-1 = unlimited)
    boost_posterior: 0.0             # Posterior boost factor (0.0 = standard nested sampling)
    read_resume: false               # Resume from previous run
    write_resume: true               # Write resume files for future resumption
    write_live: true                 # Write live points to file
    write_dead: true                 # Write dead points to file
    write_stats: true                # Write statistics file
    equals: true                     # Use equal-weighted samples
    compression_factor: 0.36787944117144233  # exp(-1), target compression for posterior
    seed: 42                         # Random seed (-1 = random, >=0 for reproducibility)
    # Note: For MPI parallelization, run with: mpirun -np N python -m exo_skryer.run_retrieval --config ...
    # Recommended: Set runtime.threads=1 when using MPI to avoid thread oversubscription

# ----------------------------------------------------------------------------------
# Runtime Section
# ----------------------------------------------------------------------------------
runtime:
  platform: cpu           # cpu | gpu | cuda | metal
  cuda_visible_devices: 0  # or "0,1"
  threads: 1
